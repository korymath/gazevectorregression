function [Y,Xf,Af] = myNeuralNetworkFunction(X,~,~)
%MYNEURALNETWORKFUNCTION neural network simulation function.
%
% Generated by Neural Network Toolbox function genFunction, 11-Dec-2015 16:18:35.
% 
% [Y] = myNeuralNetworkFunction(X,~,~) takes these arguments:
% 
%   X = 1xTS cell, 1 inputs over TS timesteps
%   Each X{1,ts} = 4xQ matrix, input #1 at timestep ts.
% 
% and returns:
%   Y = 1xTS cell of 1 outputs over TS timesteps.
%   Each Y{1,ts} = 3xQ matrix, output #1 at timestep ts.
% 
% where Q is number of samples (or series) and TS is the number of timesteps.

%#ok<*RPMT0>

% ===== NEURAL NETWORK CONSTANTS =====

% Input 1
x1_step1_xoffset = [-3.07061724364709;-2.01080150248603;-2.65617188071353;-2.04974829372403];
x1_step1_gain = [0.396992547785389;0.484456806598736;0.421756681394341;0.480137386988033];
x1_step1_ymin = -1;

% Layer 1
b1 = [0.57588466776467650554;12.233159987998517337;-1.297939002998063529;-7.3985841895458008821;-0.55751063400164024841;9.2356359395393035072;-2.4559691128614029587;-1.4599905162771376066;-0.99043834904985550427;-1.0340431588776402005;1.2108829935759071184;-1.3979494796542801804;2.2864890592815947379;0.92774143852838764079;-0.53129973228542615171;-12.140095546815278027;1.7939062529360323417;3.0048947085541568569;-2.0472445136930024212;-2.9549928530086679856];
IW1_1 = [3.1391598301095409163 0.19908039667473828582 -2.3559062434180875201 -2.5111750154675029911;6.7174140051256925332 8.9398296489648583218 -22.100600283120861889 -15.102004020757929581;-7.5609350953833169839 6.7776275861037014181 12.856384431734518614 -7.8922626100330406373;-0.50032314977471337158 -3.9840464124491927755 -0.01791035437106832523 12.99185478011548156;2.7664239265645842458 -0.95829918686546211593 -3.9239810648897259782 1.3232797606721558026;-4.092721504276926936 -34.349951994108756992 17.04013174929880492 18.017285003460546733;6.7300926791464821264 -2.5782599514236457239 -5.3093808849891805934 1.4911815868778892646;-1.3140571668122298377 -0.075607424672186437919 1.6244751882617363137 -0.87449594606131708652;3.6197666801767969247 -2.5347269611779856824 -5.6934157009347625689 3.1663102266481653047;2.8736380240184016266 -0.49544149151405658671 -3.8859265939864919837 0.0079399763472821939525;-10.385752432147022262 -0.46451332141173223844 8.7076599450009872783 1.8356993510976868933;-15.056537615874583835 -0.47028538395399566152 13.567709542529472699 -29.610676288570321191;-31.890685418405418261 5.6001212183168664893 25.691498004962998181 9.2271552160887555516;-2.5983322358120042317 0.42189756681982237829 3.7295702854677177385 0.18792623015219547811;-0.98503134899009081593 0.039874394496102409657 0.30565170521801754422 -0.19263517613924208138;-22.242439696369370239 1.7564493621552854652 6.938968436874672463 18.173655928685150229;1.1731542434746546899 0.16143448242537689064 -1.7730145895833921976 1.3692056191668333653;16.131302266444599525 -7.4220849610172594524 -14.168500603100456559 -2.6065795804874176689;-0.70195712045456903905 1.4533649515597506507 -0.04312383163546984477 -2.3671755808976131519;1.1897803315594057683 1.4013229045152875152 -3.8779535349817182421 -2.2070932502759399441];

% Layer 2
b2 = [-0.1616382063765005872;2.490039585621030227;3.7453701717897138757];
LW2_1 = [0.10809094568335696207 0.043476752225050735445 0.044836196797972835415 0.025870917069789816506 0.35962781911481617181 0.012752148588646225122 0.11262382776851156962 -4.8284213411569076868 -0.22232320205154110226 2.5799888908283818978 -0.0089786459980513502743 0.023276961326606362274 -0.019299229218036794559 2.6450116278186359686 3.3399341596718286063 0.034124603653084298327 -2.6283144012966155323 -0.05269545234451033372 0.41418958085479773423 -0.80489235989585061759;-1.1515935388840956577 0.12686171850974131692 0.40709472536187724101 -0.24179445084184628123 2.2466866188661800408 -0.082798140548744902922 0.61187071749448052049 9.4983890871872169726 -1.0767093364798168142 -5.9679456845400622456 -0.51383776329094554836 -0.12798628004395309898 -0.17081121058244441713 -5.5288699403477385985 -0.5621333936097765438 -0.078756398094220775308 5.1413932110817199828 0.36224494271038931714 -2.3940054855843664328 1.149925453155878019;-0.40136369886817951924 0.092011277875361202616 0.16821136673498432446 -0.1776085917909938916 1.3122822121055632838 -0.048111839171604053877 0.50901006014720995285 12.079037821653127338 -0.38649715334831907798 -5.6612662283548873532 -0.39937080766144977817 -0.067214493171588465814 -0.10799974286883623487 -5.2381937150599906516 -0.66150311257395699727 -0.082851028694883477321 6.0537730233075910391 0.2569176994300913508 -1.9228562985815886854 0.93197771629180536923];

% Output 1
y1_step1_ymin = -1;
y1_step1_gain = [0.00507264122327227;0.00308290221654851;0.00412766743963992];
y1_step1_xoffset = [-127.930424736684;-845.363498754814;-581.687712664213];

% ===== SIMULATION ========

% Format Input Arguments
isCellX = iscell(X);
if ~isCellX, X = {X}; end;

% Dimensions
TS = size(X,2); % timesteps
if ~isempty(X)
    Q = size(X{1},2); % samples/series
else
    Q = 0;
end

% Allocate Outputs
Y = cell(1,TS);

% Time loop
for ts=1:TS

    % Input 1
    Xp1 = mapminmax_apply(X{1,ts},x1_step1_gain,x1_step1_xoffset,x1_step1_ymin);
    
    % Layer 1
    a1 = tansig_apply(repmat(b1,1,Q) + IW1_1*Xp1);
    
    % Layer 2
    a2 = repmat(b2,1,Q) + LW2_1*a1;
    
    % Output 1
    Y{1,ts} = mapminmax_reverse(a2,y1_step1_gain,y1_step1_xoffset,y1_step1_ymin);
end

% Final Delay States
Xf = cell(1,0);
Af = cell(2,0);

% Format Output Arguments
if ~isCellX, Y = cell2mat(Y); end
end

% ===== MODULE FUNCTIONS ========

% Map Minimum and Maximum Input Processing Function
function y = mapminmax_apply(x,settings_gain,settings_xoffset,settings_ymin)
y = bsxfun(@minus,x,settings_xoffset);
y = bsxfun(@times,y,settings_gain);
y = bsxfun(@plus,y,settings_ymin);
end

% Sigmoid Symmetric Transfer Function
function a = tansig_apply(n)
a = 2 ./ (1 + exp(-2*n)) - 1;
end

% Map Minimum and Maximum Output Reverse-Processing Function
function x = mapminmax_reverse(y,settings_gain,settings_xoffset,settings_ymin)
x = bsxfun(@minus,y,settings_ymin);
x = bsxfun(@rdivide,x,settings_gain);
x = bsxfun(@plus,x,settings_xoffset);
end
